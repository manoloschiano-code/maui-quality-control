<!DOCTYPE html> 
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maui Poke - Quality Control System 3.0</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --primary: #00BFFF;
            --secondary: #F17B67;
            --accent: #B0E0E6;
            --success: #00C896;
            --warning: #FFB800;
            --danger: #FF3B3B;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gradient-1: linear-gradient(135deg, #B0E0E6 0%, #00BFFF 100%);
            --gradient-2: linear-gradient(135deg, #F17B67 0%, #FF8A75 100%);
            --gradient-3: linear-gradient(135deg, #00BFFF 0%, #B0E0E6 100%);
            --gradient-dark: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #2d3436 50%, #00BFFF 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Animated Background */
        .animated-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background: linear-gradient(270deg, #00BFFF, #B0E0E6, #F17B67, #00BFFF);
            background-size: 800% 800%;
            animation: gradientShift 15s ease infinite;
            opacity: 0.15;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Floating Particles */
        .particles {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            from {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            to {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }
        
        /* Login Screen Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 0;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.8s ease;
        }
        
        .login-header {
            background: linear-gradient(135deg, #00BFFF 0%, #B0E0E6 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .login-header h1 {
            font-size: 2.5em;
            font-weight: 900;
            margin: 0 0 10px 0;
            letter-spacing: -1px;
        }
        
        .login-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .login-form {
            padding: 40px 30px;
        }
        
        .login-form h2 {
            color: var(--dark);
            margin: 0 0 30px 0;
            text-align: center;
            font-size: 1.5em;
        }
        
        .login-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #F17B67 0%, #FF8A75 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(241, 123, 103, 0.3);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .error-message {
            background: rgba(255, 59, 59, 0.1);
            color: var(--danger);
            padding: 12px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }
        
        .user-info span {
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px);
        }
        
        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        /* Header Update */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 0.8s ease;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .header h1 {
            font-size: 3.5em;
            font-weight: 900;
            background: linear-gradient(135deg, #fff 0%, #FC6A57 50%, #00C896 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -2px;
            position: relative;
            z-index: 1;
            animation: glow 3s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(252, 106, 87, 0.5)); }
            50% { filter: drop-shadow(0 0 40px rgba(252, 106, 87, 0.8)); }
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }
        
        /* Store Selector */
        .store-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.8s ease 0.2s both;
        }
        
        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        
        .store-card {
            background: linear-gradient(135deg, #00BFFF, #B0E0E6);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        
        .store-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .store-card:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .store-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        
        .store-card.selected {
            background: linear-gradient(135deg, #F17B67, #FF8A75);
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(241, 123, 103, 0.4);
        }
        
        .store-card.selected::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 1.5em;
        }
        
        /* Form Sections */
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.8s ease both;
            position: relative;
            overflow: hidden;
        }
        
        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-1);
            animation: colorWave 3s ease-in-out infinite;
        }
        
        @keyframes colorWave {
            0%, 100% { background: linear-gradient(135deg, #00BFFF 0%, #B0E0E6 100%); }
            33% { background: linear-gradient(135deg, #B0E0E6 0%, #F17B67 100%); }
            66% { background: linear-gradient(135deg, #F17B67 0%, #00BFFF 100%); }
        }
        
        .form-section h3 {
            color: var(--dark);
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .section-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00BFFF 0%, #B0E0E6 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            animation: iconFloat 3s ease-in-out infinite;
        }
        
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Photo Upload Section */
        .photo-upload-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 20px;
            margin-top: 30px;
            border: 2px dashed #00BFFF;
            transition: all 0.3s;
        }
        
        .photo-upload-section:hover {
            border-color: #F17B67;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .upload-area {
            position: relative;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 15px;
        }
        
        .upload-area:hover {
            background: rgba(0, 191, 255, 0.05);
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #00BFFF;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .upload-text {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #999;
            font-size: 0.9em;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .photo-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .photo-preview {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s ease;
        }
        
        .photo-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .photo-preview:hover img {
            transform: scale(1.05);
        }
        
        .photo-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 59, 59, 0.9);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-remove:hover {
            background: var(--danger);
            transform: scale(1.1);
        }
        
        .photo-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 0.85em;
            text-align: center;
        }
        
        /* Advanced Rating System */
        .rating-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .rating-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .rating-item::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(252, 106, 87, 0.1) 0%, transparent 70%);
            transition: all 0.5s;
        }
        
        .rating-item:hover::before {
            top: -150%;
            left: -150%;
        }
        
        .rating-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }
        
        .rating-item label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
            display: block;
            font-size: 1.1em;
        }
        
        /* Grade Buttons System */
        .grade-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            position: relative;
        }
        
        .grade-btn {
            width: 50px;
            height: 50px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .grade-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }
        
        .grade-btn[data-value="5"] {
            color: var(--success);
            border-color: var(--success);
        }
        
        .grade-btn[data-value="5"]:hover,
        .grade-btn[data-value="5"].active {
            background: var(--success);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 200, 150, 0.3);
        }
        
        .grade-btn[data-value="4"] {
            color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .grade-btn[data-value="4"]:hover,
        .grade-btn[data-value="4"].active {
            background: #4CAF50;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .grade-btn[data-value="3"] {
            color: var(--warning);
            border-color: var(--warning);
        }
        
        .grade-btn[data-value="3"]:hover,
        .grade-btn[data-value="3"].active {
            background: var(--warning);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 184, 0, 0.3);
        }
        
        .grade-btn[data-value="2"] {
            color: #FF9800;
            border-color: #FF9800;
        }
        
        .grade-btn[data-value="2"]:hover,
        .grade-btn[data-value="2"].active {
            background: #FF9800;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }
        
        .grade-btn[data-value="1"] {
            color: var(--danger);
            border-color: var(--danger);
        }
        
        .grade-btn[data-value="1"]:hover,
        .grade-btn[data-value="1"].active {
            background: var(--danger);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 59, 59, 0.3);
        }
        
        .grade-btn.active::before {
            background: rgba(255, 255, 255, 0.3);
            width: 100px;
            height: 100px;
        }
        
        /* Modern Input Styles */
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid transparent;
            border-radius: 15px;
            font-size: 1em;
            background: #f8f9fa;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 5px 20px rgba(0, 90, 167, 0.2);
            transform: translateY(-2px);
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Progress Indicator */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Submit Button */
        .submit-section {
            text-align: center;
            margin: 40px 0;
            animation: slideUp 0.8s ease 0.6s both;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 1.3em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.4s;
            box-shadow: 0 10px 30px rgba(0, 90, 167, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .submit-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .submit-btn:hover::before {
            width: 400px;
            height: 400px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 50px rgba(0, 90, 167, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .submit-btn.loading {
            animation: pulse 1.5s infinite;
        }
        
        /* Dashboard Section */
        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 35px;
            margin-top: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.8s ease 0.8s both;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #00BFFF 0%, #B0E0E6 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #F17B67 0%, #FF8A75 100%);
        }
        
        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #B0E0E6 0%, #87CEEB 100%);
        }
        
        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #00BFFF 0%, #00A5E0 100%);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 191, 255, 0.4);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 900;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            margin-top: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        #performanceChart {
            max-width: 100%;
            height: 300px;
        }
        
        /* Report Cards */
        .reports-grid {
            display: grid;
            gap: 20px;
            margin-top: 25px;
        }
        
        .report-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border-left: 5px solid;
            animation: slideRight 0.5s ease both;
        }
        
        .report-card:hover {
            transform: translateX(10px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .report-card.excellent { border-left-color: var(--success); }
        .report-card.good { border-left-color: var(--warning); }
        .report-card.poor { border-left-color: var(--danger); }
        
        .report-info h4 {
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 1.2em;
        }
        
        .report-meta {
            color: #666;
            font-size: 0.9em;
        }
        
        .report-score {
            font-size: 2em;
            font-weight: 900;
            padding: 15px;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .has-photos-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-left: 10px;
            font-weight: 600;
        }
        
        /* Success Message */
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            text-align: center;
            animation: successPop 0.5s ease forwards;
        }
        
        @keyframes successPop {
            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--success) 0%, #00a878 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 3em;
            color: white;
            animation: checkmark 0.8s ease 0.3s both;
        }
        
        @keyframes checkmark {
            0% { transform: scale(0) rotate(0); }
            50% { transform: scale(1.2) rotate(360deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        /* Modal Styles */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            opacity: 0;
            transition: opacity 0.3s;
            padding: 20px;
        }
        
        .report-modal.active {
            opacity: 1;
        }
        
        .modal-content {
            background: white;
            border-radius: 25px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: modalSlideUp 0.3s ease;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .photos-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .gallery-photo {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .gallery-photo:hover {
            transform: scale(1.05);
        }
        
        .gallery-photo img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }
        
        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .lightbox-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 3em;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .lightbox-close:hover {
            transform: rotate(90deg);
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1999;
            display: none;
        }
        
        .overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Button Styles */
        .view-report-btn, .resend-email-btn, .delete-report-btn {
            background: rgba(0, 90, 167, 0.1);
            border: 2px solid var(--primary);
            color: var(--primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .view-report-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 90, 167, 0.3);
        }
        
        .resend-email-btn {
            background: rgba(0, 200, 150, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
        }
        
        .resend-email-btn:hover {
            background: var(--success);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 200, 150, 0.3);
        }
        
        .delete-report-btn {
            background: rgba(255, 59, 59, 0.1);
            border: 2px solid var(--danger);
            color: var(--danger);
        }
        
        .delete-report-btn:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 59, 59, 0.3);
        }
        
        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideRight {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5em;
            }
            
            .store-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .rating-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .submit-btn {
                padding: 18px 40px;
                font-size: 1.1em;
            }
            
            .photo-preview-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .form-section {
                padding: 25px 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>
    <div class="particles" id="particles"></div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <div class="logo-container" style="background: #B0E0E6; padding: 20px 40px; border-radius: 15px; margin-bottom: 20px; display: inline-block;">
                        <div style="font-size: 3em; font-weight: 900; color: #F17B67; letter-spacing: -3px; margin-bottom: -10px;">MAUI</div>
                        <div style="font-size: 1.8em; font-weight: 600; color: #F17B67; letter-spacing: 8px; margin-left: 2px;">POKE</div>
                    </div>
                    <p>Sistema Controllo Qualità</p>
                </div>
                <div class="login-form">
                    <h2>Accesso Riservato</h2>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Inserisci username" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Inserisci password" autocomplete="current-password">
                    </div>
                    <button type="button" class="login-btn" onclick="handleLogin()">ACCEDI</button>
                    <div id="loginError" class="error-message" style="display: none;">
                        Username o password non validi
                    </div>
                </div>
                <div class="login-footer" style="background: #f8f9fa; padding: 20px; text-align: center; color: #666; font-size: 0.9em;">
                    <p>© 2024 Maui Poke - Quality Control System</p>
                </div>
            </div>
        </div>
        
        <!-- Main Application (hidden by default) -->
        <div id="mainApp" style="display: none;">
            <div class="header">
                <div class="logo-container" style="background: #B0E0E6; padding: 15px 30px; border-radius: 12px; margin-bottom: 10px; display: inline-block;">
                    <div style="font-size: 2.2em; font-weight: 900; color: #F17B67; letter-spacing: -2px; margin-bottom: -8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">MAUI</div>
                    <div style="font-size: 1.3em; font-weight: 600; color: #F17B67; letter-spacing: 6px; margin-left: 2px;">POKE</div>
                </div>
                <p>Sistema Controllo Qualità - Rete Store</p>
                <div class="user-info">
                    <span id="currentUser"></span>
                    <button onclick="handleLogout()" class="logout-btn">Esci</button>
                </div>
            </div>
        
        <div class="store-selector">
            <h3 style="color: var(--dark); margin-bottom: 20px; font-size: 1.5em;">📍 Seleziona Store</h3>
            <div class="store-grid">
                <div class="store-card" data-store="Lugano">Lugano</div>
                <div class="store-card" data-store="Locarno">Locarno</div>
                <div class="store-card" data-store="Mendrisio">Mendrisio</div>
                <div class="store-card" data-store="Grancia">Grancia</div>
                <div class="store-card" data-store="Lugano Centro">Lugano Centro</div>
                <div class="store-card" data-store="Lido">Lido</div>
                <div class="store-card" data-store="Maui Kitchen">Maui Kitchen</div>
            </div>
        </div>
        
        <form id="qualityForm">
            <div class="form-section">
                <h3>
                    <div class="section-icon">ℹ️</div>
                    Informazioni Generali
                </h3>
                <div class="form-group">
                    <label for="inspector">Nome Ispettore</label>
                    <input type="text" id="inspector" name="inspector" required placeholder="Inserisci il tuo nome" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label for="date">Data Ispezione</label>
                    <input type="date" id="date" name="date" required readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label for="time">Ora Ispezione</label>
                    <input type="time" id="time" name="time" required readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label for="personale">Personale in Servizio</label>
                    <textarea id="personale" name="personale" placeholder="Elenca il personale presente durante l'ispezione"></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h3>
                    <div class="section-icon">📸</div>
                    Documentazione Fotografica
                </h3>
                <div class="photo-upload-section">
                    <div class="upload-area" onclick="document.getElementById('photoInput').click()">
                        <div class="upload-icon">📷</div>
                        <div class="upload-text">Clicca per caricare foto</div>
                        <div class="upload-hint">Formati supportati: JPG, PNG, GIF (max 5MB per foto)</div>
                        <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotoUpload(event)">
                    </div>
                    <div class="photo-preview-container" id="photoPreviewContainer"></div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>
                    <div class="section-icon">🧹</div>
                    Valutazione Pulizia
                </h3>
                <div class="rating-grid">
                    <div class="rating-item">
                        <label>Pulizia Generale</label>
                        <div class="grade-buttons" data-field="pulizia_generale">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Bancone e Superfici</label>
                        <div class="grade-buttons" data-field="pulizia_bancone">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Pavimenti</label>
                        <div class="grade-buttons" data-field="pulizia_pavimenti">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Servizi Igienici</label>
                        <div class="grade-buttons" data-field="pulizia_bagni">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="pulizia_note">Note e Osservazioni</label>
                    <textarea id="pulizia_note" name="pulizia_note" placeholder="Dettagli specifici sulla pulizia..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h3>
                    <div class="section-icon">👥</div>
                    Comportamento Staff
                </h3>
                <div class="rating-grid">
                    <div class="rating-item">
                        <label>Cortesia</label>
                        <div class="grade-buttons" data-field="staff_cortesia">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Professionalità</label>
                        <div class="grade-buttons" data-field="staff_professionalita">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Velocità Servizio</label>
                        <div class="grade-buttons" data-field="staff_velocita">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Conoscenza Prodotti</label>
                        <div class="grade-buttons" data-field="staff_conoscenza">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="staff_note">Note e Osservazioni</label>
                    <textarea id="staff_note" name="staff_note" placeholder="Dettagli sul comportamento dello staff..."></textarea>
                </div>
            </div>
            
            <div class="form-section" style="background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%); border: 2px solid #ff6b6b;">
                <h3>
                    <div class="section-icon" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8787 100%);">⚠️</div>
                    Segnalazione Disciplinare
                </h3>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="necessita_ammonimento" name="necessita_ammonimento" 
                               style="width: 20px; height: 20px; cursor: pointer;"
                               onchange="toggleAmmonimento()">
                        <span style="font-size: 1.1em; color: #FF6B6B; font-weight: 700;">
                            Necessità di Ammonimento
                        </span>
                    </label>
                </div>
                
                <div id="ammonimentoDetails" style="display: none; margin-top: 20px; padding: 20px; background: rgba(255, 107, 107, 0.1); border-radius: 15px; border: 1px solid rgba(255, 107, 107, 0.3);">
                    <div class="form-group">
                        <label for="nome_dipendente" style="color: #FF6B6B; font-weight: 600;">
                            👤 Nome Dipendente
                        </label>
                        <input type="text" id="nome_dipendente" name="nome_dipendente" 
                               placeholder="Inserisci il nome del dipendente da ammonire"
                               style="border-color: #FF6B6B;">
                    </div>
                    
                    <div class="form-group">
                        <label for="motivazione_ammonimento" style="color: #FF6B6B; font-weight: 600;">
                            📝 Motivazione
                        </label>
                        <textarea id="motivazione_ammonimento" name="motivazione_ammonimento" 
                                  placeholder="Descrivi dettagliatamente il motivo dell'ammonimento..."
                                  style="min-height: 150px; border-color: #FF6B6B;"></textarea>
                    </div>
                    
                    <div style="padding: 15px; background: rgba(255, 59, 59, 0.1); border-radius: 10px; border-left: 4px solid #FF3B3B;">
                        <p style="color: #FF3B3B; font-weight: 600; margin: 0;">
                            ⚠️ ATTENZIONE: Questa segnalazione verrà inviata direttamente alla direzione.
                        </p>
                    </div>
                </div>
            </div>
            
            <script>
                function toggleAmmonimento() {
                    const checkbox = document.getElementById('necessita_ammonimento');
                    const details = document.getElementById('ammonimentoDetails');
                    
                    if (checkbox.checked) {
                        details.style.display = 'block';
                        // Anima l'apertura
                        details.style.opacity = '0';
                        setTimeout(() => {
                            details.style.transition = 'opacity 0.3s ease';
                            details.style.opacity = '1';
                        }, 10);
                    } else {
                        details.style.opacity = '0';
                        setTimeout(() => {
                            details.style.display = 'none';
                            // Pulisci i campi quando si deseleziona
                            document.getElementById('nome_dipendente').value = '';
                            document.getElementById('motivazione_ammonimento').value = '';
                        }, 300);
                    }
                }
            </script>
            
            <div class="form-section">
                <h3>
                    <div class="section-icon">🥗</div>
                    Freschezza Ingredienti
                </h3>
                <div class="rating-grid">
                    <div class="rating-item">
                        <label>Pesce e Proteine</label>
                        <div class="grade-buttons" data-field="fresh_pesce">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Verdure</label>
                        <div class="grade-buttons" data-field="fresh_verdure">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Riso e Cereali</label>
                        <div class="grade-buttons" data-field="fresh_riso">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                    <div class="rating-item">
                        <label>Salse e Condimenti</label>
                        <div class="grade-buttons" data-field="fresh_salse">
                            <button type="button" class="grade-btn" data-value="5">5</button>
                            <button type="button" class="grade-btn" data-value="4">4</button>
                            <button type="button" class="grade-btn" data-value="3">3</button>
                            <button type="button" class="grade-btn" data-value="2">2</button>
                            <button type="button" class="grade-btn" data-value="1">1</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="fresh_note">Note e Osservazioni</label>
                    <textarea id="fresh_note" name="fresh_note" placeholder="Dettagli sulla freschezza degli ingredienti..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h3>
                    <div class="section-icon">📝</div>
                    Valutazione Finale
                </h3>
                <div class="form-group">
                    <label for="valutazione_finale">Voto Complessivo (1-10)</label>
                    <select id="valutazione_finale" name="valutazione_finale" required>
                        <option value="">Seleziona un voto...</option>
                        <option value="10">10 - Eccellente</option>
                        <option value="9">9 - Ottimo</option>
                        <option value="8">8 - Molto Buono</option>
                        <option value="7">7 - Buono</option>
                        <option value="6">6 - Sufficiente</option>
                        <option value="5">5 - Insufficiente</option>
                        <option value="4">4 - Scarso</option>
                        <option value="3">3 - Molto Scarso</option>
                        <option value="2">2 - Pessimo</option>
                        <option value="1">1 - Inaccettabile</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="note_finali">Note Generali e Raccomandazioni</label>
                    <textarea id="note_finali" name="note_finali" placeholder="Osservazioni finali e suggerimenti per il miglioramento..."></textarea>
                </div>
            </div>
            
            <div class="submit-section">
                <button type="button" class="submit-btn" id="submitBtn">
                    <span id="btnText">INVIA REPORT</span>
                </button>
            </div>
        </form>
        
        <div class="dashboard">
            <h3 style="color: var(--dark); margin-bottom: 30px; font-size: 1.8em;">📊 Dashboard Analytics</h3>
            
            <!-- Month Filter -->
            <div class="month-filter" style="margin-bottom: 30px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <label for="monthSelect" style="font-weight: 600; margin-right: 15px; color: var(--dark);">📅 Seleziona Periodo:</label>
                <select id="monthSelect" style="padding: 10px 20px; border-radius: 10px; border: 2px solid #ddd; font-size: 1em; min-width: 200px;">
                    <option value="all">Tutti i Report</option>
                </select>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="stat-number" id="totalReports">0</div>
                    <div class="stat-label">Report Totali</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-number" id="avgScore">0.0</div>
                    <div class="stat-label">Media Voti</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stat-number" id="bestStore">-</div>
                    <div class="stat-label">Miglior Store</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stat-number" id="worstStore">-</div>
                    <div class="stat-label">Da Migliorare</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            
            <h4 style="color: var(--dark); margin: 30px 0 20px; font-size: 1.4em;">📝 Report del Periodo</h4>
            <div class="reports-grid" id="recentReports">
                <p style="text-align: center; color: #999;">Nessun report disponibile</p>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Lightbox for Photos -->
    <div class="lightbox" id="lightbox">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <div class="lightbox-content">
            <img id="lightboxImage" src="" alt="Foto ingrandita">
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div class="success-message" id="successMessage" style="display: none;">
        <div class="success-icon">✓</div>
        <h2 style="color: var(--dark); margin-bottom: 10px;">Report Inviato!</h2>
        <p style="color: #666;">Il report è stato salvato e inviato con successo.</p>
    </div>
    
    <!-- Script esterni -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // ====== CONFIGURAZIONE INIZIALE ======
        console.log('🚀 Avvio sistema Maui Poke QC...');
        
        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDpRXiwDqtgCxZvgcv55FeYsd_DOhj7pco",
            authDomain: "maui-poke-qc.firebaseapp.com",
            projectId: "maui-poke-qc",
            storageBucket: "maui-poke-qc.firebasestorage.app",
            messagingSenderId: "88170125820",
            appId: "1:88170125820:web:45215896c8279ef3533a79"
        };
        
        // Variabili globali
        let db = null;
        let useFirebase = false;
        let currentUser = null;
        let selectedStore = '';
        let ratings = {};
        let uploadedPhotos = [];
        
        // User database (DEFINITO UNA SOLA VOLTA)
        const USERS = {
            'admin': { password: 'MauiPoke2024!', role: 'Administrator', name: 'Amministratore' },
            'manolo': { password: 'Maui@Quality24', role: 'Manager', name: 'Manolo Schiano' },
            'antonello': { password: 'Poke@Control24', role: 'Manager', name: 'Antonello Romeo' },
            'luigi': { password: 'Luigi@Maui24', role: 'Manager', name: 'Luigi' },
            'rocco': { password: 'Rocco@Poke24', role: 'Inspector', name: 'Rocco' },
            'inspector1': { password: 'Quality@2024', role: 'Inspector', name: 'Ispettore 1' },
            'inspector2': { password: 'Control@2024', role: 'Inspector', name: 'Ispettore 2' }
        };
        
        // ====== FUNZIONI DATABASE (DEVONO ESSERE DEFINITE PRIMA) ======
        function getAllReports() {
            if (useFirebase && db) {
                return db.collection('reports')
                    .orderBy('timestamp', 'desc')
                    .get()
                    .then(snapshot => {
                        const reports = [];
                        snapshot.forEach(doc => {
                            reports.push({ id: doc.id, ...doc.data() });
                        });
                        console.log('📊 Report da Firebase:', reports.length);
                        return reports;
                    })
                    .catch(error => {
                        console.error('Errore Firebase:', error);
                        return JSON.parse(localStorage.getItem('mauiReports') || '[]');
                    });
            } else {
                const reports = JSON.parse(localStorage.getItem('mauiReports') || '[]');
                console.log('📊 Report da localStorage:', reports.length);
                return Promise.resolve(reports);
            }
        }
        
        function saveReports(reportsArray) {
            localStorage.setItem('mauiReports', JSON.stringify(reportsArray));
            
            if (useFirebase && db) {
                const batch = db.batch();
                reportsArray.forEach(report => {
                    const docRef = db.collection('reports').doc(report.id.toString());
                    batch.set(docRef, report);
                });
                batch.commit()
                    .then(() => console.log('✅ Salvato su Firebase'))
                    .catch(error => console.error('Errore Firebase:', error));
            }
        }
        
        function addReport(report) {
            const localReports = JSON.parse(localStorage.getItem('mauiReports') || '[]');
            localReports.push(report);
            localStorage.setItem('mauiReports', JSON.stringify(localReports));
            
            if (useFirebase && db) {
                return db.collection('reports')
                    .doc(report.id.toString())
                    .set(report)
                    .then(() => {
                        console.log('✅ Report salvato su Firebase');
                        return report;
                    })
                    .catch(error => {
                        console.error('Errore Firebase:', error);
                        return report;
                    });
            }
            
            console.log('💾 Report salvato su localStorage');
            return Promise.resolve(report);
        }
        
        function removeReport(reportId) {
            const localReports = JSON.parse(localStorage.getItem('mauiReports') || '[]');
            const filtered = localReports.filter(r => r.id !== reportId);
            localStorage.setItem('mauiReports', JSON.stringify(filtered));
            
            if (useFirebase && db) {
                return db.collection('reports')
                    .doc(reportId.toString())
                    .delete()
                    .then(() => console.log('✅ Rimosso da Firebase'))
                    .catch(error => console.error('Errore Firebase:', error));
            }
            
            return Promise.resolve();
        }
        
        // ====== INIZIALIZZAZIONE SERVIZI ======
        
        // Inizializza Firebase
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                useFirebase = true;
                console.log('✅ Firebase connesso - Database CONDIVISO attivo!');
                console.log('🌐 Tutti vedranno gli stessi report in tempo reale');
            } else {
                console.warn('⚠️ Firebase non disponibile - usando localStorage');
            }
        } catch (error) {
            console.error('❌ Errore Firebase:', error);
            console.log('📦 Fallback su localStorage');
        }
        
        // Inizializza EmailJS
        try {
            emailjs.init("azBz9PrKR4ljQuq93");
            console.log('✅ EmailJS pronto');
        } catch (e) {
            console.warn('⚠️ EmailJS non disponibile');
        }
        
        // ====== FUNZIONI UTILITY ======
        window.checkDatabaseStatus = function() {
            if (useFirebase && db) {
                console.log('✅ Database: Firebase (CONDIVISO)');
                console.log('🌐 Tutti gli utenti vedranno gli stessi report');
                console.log('📍 Project: maui-poke-qc');
            } else {
                console.log('⚠️ Database: localStorage (LOCALE)');
                console.log('💾 I report sono salvati solo su questo browser');
            }
        };
        
        window.debugReports = async function() {
            const reports = await getAllReports();
            console.log('=== REPORT NEL SISTEMA ===');
            console.log('Totale:', reports.length);
            console.log('Database:', useFirebase ? 'Firebase' : 'localStorage');
            reports.forEach((r, i) => {
                console.log(`${i+1}. ${r.store} - ${r.date} - Voto: ${r.score}`);
            });
            return reports;
        };
        
        // ====== CODICE PRINCIPALE DELL'APPLICAZIONE ======
        // NON inizializzare reports qui - lo faremo sempre dal localStorage
        
        // Funzione di debug per verificare i report
        function debugReports() {
            const reports = getAllReports();
            console.log('=== DEBUG REPORT SYSTEM ===');
            console.log('Utente corrente:', currentUser?.name || 'Non loggato');
            console.log('Totale report nel sistema:', reports.length);
            console.log('Report dettagliati:');
            reports.forEach((report, index) => {
                console.log(`Report ${index + 1}:`, {
                    id: report.id,
                    store: report.store,
                    inspector: report.inspector,
                    date: report.date,
                    score: report.score,
                    submittedBy: report.submittedBy
                });
            });
            console.log('=========================');
            return reports;
        }
        
        // Aggiungi funzione globale per test
        window.debugMauiReports = debugReports;
        window.clearAllReports = function() {
            if (confirm('⚠️ ATTENZIONE: Questo cancellerà TUTTI i report. Sei sicuro?')) {
                localStorage.removeItem('mauiReports');
                console.log('✅ Tutti i report sono stati cancellati');
                updateDashboard();
            }
        };
        window.addTestReport = function() {
            const testReport = {
                id: Date.now(),
                store: 'Test Store ' + Math.floor(Math.random() * 100),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().slice(0, 5),
                inspector: 'Test Inspector',
                personale: 'Test Staff',
                ratings: {
                    pulizia_generale: 5,
                    pulizia_bancone: 4,
                    staff_cortesia: 5,
                    fresh_pesce: 4
                },
                score: '8',
                notes: {
                    final: 'Report di test creato automaticamente'
                },
                photos: [],
                submittedBy: 'test'
            };
            
            const reports = getAllReports();
            reports.push(testReport);
            saveReports(reports);
            console.log('✅ Report di test aggiunto');
            updateDashboard();
        };
        
        // Check if user is already logged in
        function checkAuth() {
            const savedSession = sessionStorage.getItem('mauiUser');
            if (savedSession) {
                currentUser = JSON.parse(savedSession);
                console.log('🔐 Utente autenticato:', currentUser.name);
                getAllReports().then(reports => {
                    console.log('📊 Report totali nel sistema:', reports.length);
                });
                showMainApp();
            }
        }
        
        // Handle Login
        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                errorDiv.textContent = 'Inserisci username e password';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (USERS[username] && USERS[username].password === password) {
                currentUser = {
                    username: username,
                    name: USERS[username].name,
                    role: USERS[username].role
                };
                
                sessionStorage.setItem('mauiUser', JSON.stringify(currentUser));
                
                console.log('✅ Login effettuato:', currentUser.name);
                getAllReports().then(reports => {
                    console.log('📊 Report totali disponibili:', reports.length);
                });
                
                showMainApp();
                
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                errorDiv.style.display = 'none';
            } else {
                errorDiv.textContent = 'Username o password non validi';
                errorDiv.style.display = 'block';
                
                const loginBox = document.querySelector('.login-box');
                loginBox.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    loginBox.style.animation = '';
                }, 500);
            }
        }
        
        // Show Main Application
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUser').textContent = `👤 ${currentUser.name}`;
            
            initializeApp();
            
            setTimeout(() => {
                const inspectorField = document.getElementById('inspector');
                if (inspectorField) {
                    inspectorField.value = currentUser.name;
                    inspectorField.readOnly = true;
                    inspectorField.style.backgroundColor = '#f0f0f0';
                    inspectorField.style.cursor = 'not-allowed';
                }
            }, 100);
        }
        
        // Handle Logout
        function handleLogout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                currentUser = null;
                sessionStorage.removeItem('mauiUser');
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }
        
        // Initialize App
        function initializeApp() {
            console.log('🚀 Inizializzazione app per:', currentUser?.name);
            
            // Verifica stato database
            checkDatabaseStatus();
            
            // Carica i report e mostra il conteggio
            getAllReports().then(reports => {
                console.log('📦 Report disponibili:', reports.length);
                if (reports.length > 0) {
                    console.log('📋 Ultimo report:', {
                        store: reports[0].store,
                        inspector: reports[0].inspector,
                        date: reports[0].date
                    });
                }
            }).catch(error => {
                console.error('Errore caricamento report:', error);
            });
            
            initializeParticles();
            initializeDateTime();
            initializeStoreSelector();
            initializeRatings();
            initializeForm();
            updateDashboard();
            updateProgressBar();
        }
        
        // Particles Animation
        function initializeParticles() {
            const particlesContainer = document.getElementById('particles');
            particlesContainer.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }
        
        // DateTime
        function initializeDateTime() {
            const now = new Date();
            const dateField = document.getElementById('date');
            const timeField = document.getElementById('time');
            
            if (dateField) {
                dateField.valueAsDate = now;
                dateField.readOnly = true;
            }
            
            if (timeField) {
                timeField.value = now.toTimeString().slice(0, 5);
                timeField.readOnly = true;
            }
        }
        
        // Store Selector
        function initializeStoreSelector() {
            document.querySelectorAll('.store-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.store-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedStore = this.dataset.store;
                    updateProgressBar();
                });
            });
        }
        
        // Photo Upload Handler - CON COMPRESSIONE
        async function handlePhotoUpload(event) {
            const files = event.target.files;
            const container = document.getElementById('photoPreviewContainer');
            
            for (let file of files) {
                // Limite dimensione file
                if (file.size > 5 * 1024 * 1024) {
                    alert(`Il file ${file.name} supera i 5MB`);
                    continue;
                }
                
                if (!file.type.startsWith('image/')) {
                    alert(`Il file ${file.name} non è un'immagine valida`);
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    // COMPRIMI L'IMMAGINE
                    let imageData = e.target.result;
                    
                    // Se l'immagine è più grande di 100KB, comprimila
                    if (imageData.length > 100 * 1024) {
                        console.log('📸 Compressione immagine in corso...');
                        imageData = await compressImage(imageData, 600); // Max 600px larghezza
                    }
                    
                    const photoId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const photoData = {
                        id: photoId,
                        data: imageData,
                        name: file.name,
                        size: imageData.length,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Verifica dimensione dopo compressione
                    if (photoData.size > 500 * 1024) {
                        alert(`Foto troppo grande anche dopo compressione. Usa foto più piccole.`);
                        return;
                    }
                    
                    uploadedPhotos.push(photoData);
                    
                    const preview = document.createElement('div');
                    preview.className = 'photo-preview';
                    preview.id = `preview_${photoId}`;
                    preview.innerHTML = `
                        <img src="${imageData}" alt="${file.name}" onclick="openLightbox('${imageData}')">
                        <button class="photo-remove" onclick="removePhoto('${photoId}')">×</button>
                        <div class="photo-caption">${file.name} (${(photoData.size/1024).toFixed(0)}KB)</div>
                    `;
                    
                    container.appendChild(preview);
                    updateProgressBar();
                    
                    console.log(`✅ Foto aggiunta: ${file.name} (${(photoData.size/1024).toFixed(0)}KB)`);
                };
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        }
        
        // Funzione di compressione immagini
        function compressImage(base64String, maxWidth = 600) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Ridimensiona mantenendo proporzioni
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Comprimi a 50% qualità JPEG
                    const compressed = canvas.toDataURL('image/jpeg', 0.5);
                    resolve(compressed);
                };
                img.src = base64String;
            });
        }
        
        // Remove Photo
        function removePhoto(photoId) {
            uploadedPhotos = uploadedPhotos.filter(p => p.id !== photoId);
            const preview = document.getElementById(`preview_${photoId}`);
            if (preview) {
                preview.remove();
            }
            updateProgressBar();
        }
        
        // Lightbox Functions
        function openLightbox(imageSrc) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            lightboxImage.src = imageSrc;
            lightbox.classList.add('active');
        }
        
        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
        }
        
        // Grade Ratings
        function initializeRatings() {
            document.querySelectorAll('.grade-buttons').forEach(gradeGroup => {
                const field = gradeGroup.dataset.field;
                const buttons = gradeGroup.querySelectorAll('.grade-btn');
                
                buttons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        if (this.classList.contains('active')) {
                            this.classList.remove('active');
                            delete ratings[field];
                        } else {
                            buttons.forEach(btn => btn.classList.remove('active'));
                            this.classList.add('active');
                            ratings[field] = parseInt(this.dataset.value);
                        }
                        
                        updateProgressBar();
                        calculateAutoScore();
                    });
                });
            });
        }
        
        // Auto Calculate Score
        function calculateAutoScore() {
            const ratingValues = Object.values(ratings);
            if (ratingValues.length > 0) {
                const avg = ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length;
                const score = Math.round(avg * 2);
                document.getElementById('valutazione_finale').value = score;
            }
        }
        
        // Progress Bar
        function updateProgressBar() {
            const totalFields = 17;
            let completed = 0;
            
            if (selectedStore) completed++;
            if (document.getElementById('inspector').value) completed++;
            if (document.getElementById('date').value) completed++;
            if (document.getElementById('time').value) completed++;
            completed += Object.keys(ratings).length;
            if (document.getElementById('valutazione_finale').value) completed++;
            if (uploadedPhotos.length > 0) completed++;
            
            const progress = (completed / totalFields) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        // Form Submission
        function initializeForm() {
            // Usa addEventListener invece di onsubmit per evitare problemi sandbox
            const form = document.getElementById('qualityForm');
            const submitBtn = document.getElementById('submitBtn');
            
            // Gestisci il click sul pulsante invece del submit del form
            submitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleFormSubmission();
            });
            
            // Previeni il submit normale del form
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
            
            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('input', updateProgressBar);
            });
        }
        
        function handleFormSubmission() {
            if (!selectedStore) {
                alert('Seleziona uno store!');
                return;
            }
            
            if (!document.getElementById('valutazione_finale').value) {
                alert('Seleziona un voto complessivo!');
                return;
            }
            
            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            
            btn.classList.add('loading');
            btnText.textContent = 'INVIO IN CORSO...';
            btn.disabled = true;
            
            try {
                const now = new Date();
                document.getElementById('date').valueAsDate = now;
                document.getElementById('time').value = now.toTimeString().slice(0, 5);
                
                // Raccogli i dati manualmente invece di usare FormData
                const report = {
                    id: Date.now(),
                    store: selectedStore,
                    date: document.getElementById('date').value,
                    time: document.getElementById('time').value,
                    inspector: currentUser.name,
                    personale: document.getElementById('personale').value || '',
                    ratings: {...ratings},
                    score: document.getElementById('valutazione_finale').value,
                    notes: {
                        pulizia: document.getElementById('pulizia_note').value || '',
                        staff: document.getElementById('staff_note').value || '',
                        fresh: document.getElementById('fresh_note').value || '',
                        final: document.getElementById('note_finali').value || ''
                    },
                    ammonimento: {
                        necessario: document.getElementById('necessita_ammonimento').checked,
                        nome_dipendente: document.getElementById('nome_dipendente').value || '',
                        motivazione: document.getElementById('motivazione_ammonimento').value || ''
                    },
                    photos: [...uploadedPhotos],
                    submittedBy: currentUser.username,
                    timestamp: new Date().toISOString()
                };
                
                console.log('Report da salvare:', report);
                
                // Usa la funzione async per salvare
                addReport(report).then(() => {
                    console.log('Report salvato con successo');
                    
                    // Invia email (non bloccare se fallisce)
                    sendEmail(report);
                    
                    // Mostra successo dopo un breve delay
                    setTimeout(() => {
                        showSuccess();
                        resetForm();
                        updateDashboard();
                        btn.classList.remove('loading');
                        btnText.textContent = 'INVIA REPORT';
                        btn.disabled = false;
                        console.log('Processo completato con successo');
                    }, 1500);
                }).catch(error => {
                    console.error('Errore durante il salvataggio:', error);
                    alert('Errore durante il salvataggio. Riprova.');
                    btn.classList.remove('loading');
                    btnText.textContent = 'INVIA REPORT';
                    btn.disabled = false;
                });
                
            } catch (error) {
                console.error('Errore durante il salvataggio del report:', error);
                alert('Si è verificato un errore durante il salvataggio del report. Dettagli: ' + error.message);
                
                // Reset button anche in caso di errore
                btn.classList.remove('loading');
                btnText.textContent = 'INVIA REPORT';
                btn.disabled = false;
                
                // Aggiorna comunque la dashboard
                updateDashboard();
            }
        }
        
        function sendEmail(report) {
            try {
                const ratingToText = (value) => {
                    const grades = { 5: '5 - Eccellente', 4: '4 - Buono', 3: '3 - Sufficiente', 2: '2 - Scarso', 1: '1 - Inaccettabile' };
                    return grades[value] || 'Non valutato';
                };
                
                const templateParams = {
                    to_email: 'manolo.schiano@mauipoke.ch',
                    cc_email: 'antonello.romeo@mauipoke.ch',
                    subject: `Quality Report - ${report.store} - ${new Date(report.date).toLocaleDateString('it-IT')}`,
                    store_name: report.store || 'Non specificato',
                    inspector_name: report.inspector || 'Non specificato',
                    report_date: report.date ? new Date(report.date).toLocaleDateString('it-IT') : 'Non specificata',
                    report_time: report.time || 'Non specificata',
                    overall_score: report.score || '0',
                    personale: report.personale || 'Non specificato',
                    pulizia_generale: ratingToText(report.ratings?.pulizia_generale),
                    pulizia_bancone: ratingToText(report.ratings?.pulizia_bancone),
                    pulizia_pavimenti: ratingToText(report.ratings?.pulizia_pavimenti),
                    pulizia_bagni: ratingToText(report.ratings?.pulizia_bagni),
                    pulizia_note: report.notes?.pulizia || 'Nessuna nota',
                    staff_cortesia: ratingToText(report.ratings?.staff_cortesia),
                    staff_professionalita: ratingToText(report.ratings?.staff_professionalita),
                    staff_velocita: ratingToText(report.ratings?.staff_velocita),
                    staff_conoscenza: ratingToText(report.ratings?.staff_conoscenza),
                    staff_note: report.notes?.staff || 'Nessuna nota',
                    fresh_pesce: ratingToText(report.ratings?.fresh_pesce),
                    fresh_verdure: ratingToText(report.ratings?.fresh_verdure),
                    fresh_riso: ratingToText(report.ratings?.fresh_riso),
                    fresh_salse: ratingToText(report.ratings?.fresh_salse),
                    fresh_note: report.notes?.fresh || 'Nessuna nota',
                    note_finali: report.notes?.final || 'Nessuna nota generale',
                    photo_count: report.photos?.length || 0
                };
                
                console.log('Invio email con parametri:', templateParams);
                
                emailjs.send('service_cysrzkx', 'template_j203617', templateParams)
                    .then((response) => {
                        console.log('Email inviata con successo!', response);
                    })
                    .catch(error => {
                        console.error('Errore EmailJS:', error);
                        // Non bloccare il processo se l'email fallisce
                    });
            } catch (error) {
                console.error('Errore nella preparazione email:', error);
                // Non bloccare il processo se l'email fallisce
            }
        }
        
        function showSuccess() {
            const overlay = document.getElementById('overlay');
            const successMsg = document.getElementById('successMessage');
            
            overlay.classList.add('active');
            successMsg.style.display = 'block';
            
            setTimeout(() => {
                overlay.classList.remove('active');
                successMsg.style.display = 'none';
            }, 3000);
        }
        
        function resetForm() {
            try {
                document.getElementById('qualityForm').reset();
                document.querySelectorAll('.store-card').forEach(c => c.classList.remove('selected'));
                document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('active'));
                selectedStore = '';
                ratings = {};
                uploadedPhotos = [];
                document.getElementById('photoPreviewContainer').innerHTML = '';
                
                // Reset ammonimento
                document.getElementById('necessita_ammonimento').checked = false;
                document.getElementById('ammonimentoDetails').style.display = 'none';
                document.getElementById('nome_dipendente').value = '';
                document.getElementById('motivazione_ammonimento').value = '';
                
                initializeDateTime();
                updateProgressBar();
                
                const inspectorField = document.getElementById('inspector');
                if (inspectorField && currentUser) {
                    inspectorField.value = currentUser.name;
                    inspectorField.readOnly = true;
                }
            } catch (error) {
                console.error('Errore durante il reset del form:', error);
            }
        }
        
        // Dashboard - ora async
        async function updateDashboard() {
            await updateMonthFilter();
            const selectedMonth = document.getElementById('monthSelect').value;
            await updateDashboardStats(selectedMonth);
            await updateRecentReports(selectedMonth);
            await updateChart(selectedMonth);
        }
        
        async function updateMonthFilter() {
            const monthSelect = document.getElementById('monthSelect');
            const existingValue = monthSelect.value;
            
            // Ottieni sempre i report aggiornati (con await perché è async)
            const allReports = await getAllReports();
            
            const months = [...new Set(allReports.map(r => {
                const date = new Date(r.date);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();
            
            monthSelect.innerHTML = '<option value="all">Tutti i Report</option>';
            
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            months.forEach(month => {
                const [year, monthNum] = month.split('-');
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                monthSelect.appendChild(option);
            });
            
            if (existingValue && [...monthSelect.options].some(opt => opt.value === existingValue)) {
                monthSelect.value = existingValue;
            }
            
            monthSelect.onchange = () => updateDashboard();
        }
        
        async function updateDashboardStats(selectedMonth = 'all') {
            // Ottieni sempre i report aggiornati (con await)
            const allReports = await getAllReports();
            console.log('Dashboard - Totale report nel sistema:', allReports.length);
            
            let filteredReports = allReports;
            
            if (selectedMonth !== 'all') {
                filteredReports = allReports.filter(r => {
                    const date = new Date(r.date);
                    const reportMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return reportMonth === selectedMonth;
                });
            }
            
            document.getElementById('totalReports').textContent = filteredReports.length;
            
            if (filteredReports.length > 0) {
                const avgScore = filteredReports.reduce((sum, r) => sum + parseInt(r.score || 0), 0) / filteredReports.length;
                document.getElementById('avgScore').textContent = avgScore.toFixed(1);
                
                const storeScores = {};
                filteredReports.forEach(r => {
                    if (!storeScores[r.store]) {
                        storeScores[r.store] = { total: 0, count: 0 };
                    }
                    storeScores[r.store].total += parseInt(r.score || 0);
                    storeScores[r.store].count++;
                });
                
                let bestStore = '';
                let worstStore = '';
                let bestAvg = 0;
                let worstAvg = 10;
                
                Object.keys(storeScores).forEach(store => {
                    const avg = storeScores[store].total / storeScores[store].count;
                    if (avg > bestAvg) {
                        bestAvg = avg;
                        bestStore = store;
                    }
                    if (avg < worstAvg) {
                        worstAvg = avg;
                        worstStore = store;
                    }
                });
                
                document.getElementById('bestStore').textContent = bestStore || '-';
                document.getElementById('worstStore').textContent = worstStore || '-';
            } else {
                document.getElementById('avgScore').textContent = '0.0';
                document.getElementById('bestStore').textContent = '-';
                document.getElementById('worstStore').textContent = '-';
            }
        }
        
        async function updateRecentReports(selectedMonth = 'all') {
            const container = document.getElementById('recentReports');
            
            // Ottieni sempre i report aggiornati (con await)
            const allReports = await getAllReports();
            console.log('Report visualizzati - Totale:', allReports.length);
            
            let filteredReports = allReports;
            if (selectedMonth !== 'all') {
                filteredReports = allReports.filter(r => {
                    const date = new Date(r.date);
                    const reportMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return reportMonth === selectedMonth;
                });
            }
            
            if (filteredReports.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Nessun report disponibile per questo periodo</p>';
                return;
            }
            
            const sortedReports = filteredReports.sort((a, b) => 
                new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)
            );
            
            container.innerHTML = sortedReports.map(report => {
                const score = parseInt(report.score || 0);
                const scoreClass = score >= 8 ? 'excellent' : score >= 6 ? 'good' : 'poor';
                const canDelete = currentUser && currentUser.username === 'manolo';
                const hasPhotos = report.photos && report.photos.length > 0;
                const hasAmmonimento = report.ammonimento && report.ammonimento.necessario;
                
                return `
                    <div class="report-card ${scoreClass}" data-report-id="${report.id}">
                        <div class="report-info">
                            <h4>${report.store}
                                ${hasPhotos ? `<span class="has-photos-indicator">📸 ${report.photos.length} foto</span>` : ''}
                                ${hasAmmonimento ? `<span class="has-photos-indicator" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8787 100%);">⚠️ Ammonimento</span>` : ''}
                            </h4>
                            <div class="report-meta">
                                ${new Date(report.date).toLocaleDateString('it-IT')} ${report.time} - ${report.inspector}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="report-score" style="color: ${score >= 8 ? 'var(--success)' : score >= 6 ? 'var(--warning)' : 'var(--danger)'}">
                                ${score}/10
                            </div>
                            <button class="view-report-btn" onclick="viewReportDetails(${report.id})" title="Visualizza dettagli">
                                👁️
                            </button>
                            <button class="resend-email-btn" onclick="resendReportEmail(${report.id})" title="Reinvia email">
                                📧
                            </button>
                            ${canDelete ? `
                                <button class="delete-report-btn" onclick="deleteReport(${report.id})" title="Elimina report">
                                    🗑️
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // View Report Details - ora async
        async function viewReportDetails(reportId) {
            // Ottieni sempre i report aggiornati
            const allReports = await getAllReports();
            const report = allReports.find(r => r.id === reportId);
            if (!report) return;
            
            const modal = document.createElement('div');
            modal.className = 'report-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>📋 Dettagli Report - ${report.store}</h2>
                        <button onclick="closeReportModal()" class="lightbox-close" style="background: none; border: none; color: white; font-size: 2em; cursor: pointer;">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-section">
                            <h3>📍 Informazioni Generali</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Store:</strong> ${report.store}</div>
                                <div><strong>Data:</strong> ${new Date(report.date).toLocaleDateString('it-IT')}</div>
                                <div><strong>Ora:</strong> ${report.time}</div>
                                <div><strong>Ispettore:</strong> ${report.inspector}</div>
                                <div><strong>Personale:</strong> ${report.personale || 'Non specificato'}</div>
                                <div><strong>Voto Finale:</strong> <span style="font-weight: bold; color: ${report.score >= 8 ? 'var(--success)' : report.score >= 6 ? 'var(--warning)' : 'var(--danger)'}">${report.score}/10</span></div>
                            </div>
                        </div>
                        
                        ${report.photos && report.photos.length > 0 ? `
                            <div class="form-section">
                                <h3>📸 Documentazione Fotografica</h3>
                                <div class="photos-gallery">
                                    ${report.photos.map(photo => `
                                        <div class="gallery-photo">
                                            <img src="${photo.data}" alt="${photo.name}" onclick="openLightbox('${photo.data}')">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${generateRatingSection('🧹 Pulizia', {
                            'Generale': report.ratings?.pulizia_generale,
                            'Bancone': report.ratings?.pulizia_bancone,
                            'Pavimenti': report.ratings?.pulizia_pavimenti,
                            'Bagni': report.ratings?.pulizia_bagni
                        }, report.notes?.pulizia)}
                        
                        ${generateRatingSection('👥 Staff', {
                            'Cortesia': report.ratings?.staff_cortesia,
                            'Professionalità': report.ratings?.staff_professionalita,
                            'Velocità': report.ratings?.staff_velocita,
                            'Conoscenza': report.ratings?.staff_conoscenza
                        }, report.notes?.staff)}
                        
                        ${generateRatingSection('🥗 Freschezza', {
                            'Pesce': report.ratings?.fresh_pesce,
                            'Verdure': report.ratings?.fresh_verdure,
                            'Riso': report.ratings?.fresh_riso,
                            'Salse': report.ratings?.fresh_salse
                        }, report.notes?.fresh)}
                        
                        ${report.notes?.final ? `
                            <div class="form-section">
                                <h3>📝 Note Finali</h3>
                                <p>${report.notes.final}</p>
                            </div>
                        ` : ''}
                        
                        ${report.ammonimento && report.ammonimento.necessario ? `
                            <div class="form-section" style="background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%); border: 2px solid #ff6b6b;">
                                <h3 style="color: #FF6B6B;">⚠️ AMMONIMENTO DISCIPLINARE</h3>
                                <div style="padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 10px;">
                                    <p><strong>👤 Dipendente:</strong> ${report.ammonimento.nome_dipendente}</p>
                                    <p><strong>📝 Motivazione:</strong></p>
                                    <p style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #FF6B6B;">
                                        ${report.ammonimento.motivazione}
                                    </p>
                                    <p style="color: #FF3B3B; font-weight: 600; margin-top: 15px;">
                                        ⚠️ Questa segnalazione è stata inviata alla direzione
                                    </p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('active'), 10);
        }
        
        function generateRatingSection(title, ratings, notes) {
            return `
                <div class="form-section">
                    <h3>${title}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        ${Object.entries(ratings).map(([key, value]) => `
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <span>${key}:</span>
                                <span style="font-weight: bold; color: ${getRatingColor(value)}">${getRatingText(value)}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${notes ? `<div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">📝 Note: ${notes}</div>` : ''}
                </div>
            `;
        }
        
        function getRatingColor(value) {
            if (value >= 5) return 'var(--success)';
            if (value >= 4) return '#4CAF50';
            if (value >= 3) return 'var(--warning)';
            if (value >= 2) return '#FF9800';
            return 'var(--danger)';
        }
        
        function getRatingText(value) {
            const ratings = {
                5: '5 - Eccellente',
                4: '4 - Buono',
                3: '3 - Sufficiente',
                2: '2 - Scarso',
                1: '1 - Inaccettabile'
            };
            return ratings[value] || 'Non valutato';
        }
        
        function closeReportModal() {
            const modal = document.querySelector('.report-modal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        async function resendReportEmail(reportId) {
            // Ottieni sempre i report aggiornati
            const allReports = await getAllReports();
            const report = allReports.find(r => r.id === reportId);
            if (!report) return;
            
            sendEmail(report);
            alert('Email reinviata con successo!');
        }
        
        async function deleteReport(reportId) {
            if (!currentUser || currentUser.username !== 'manolo') {
                alert('Solo Manolo Schiano ha i permessi per eliminare i report');
                return;
            }
            
            if (confirm('Sei sicuro di voler eliminare definitivamente questo report?')) {
                try {
                    await removeReport(reportId);
                    updateDashboard();
                    alert('Report eliminato con successo');
                } catch (error) {
                    console.error('Errore eliminazione:', error);
                    alert('Errore durante l\'eliminazione del report');
                }
            }
        }
        
        async function updateChart(selectedMonth = 'all') {
            const ctx = document.getElementById('performanceChart');
            
            if (window.performanceChart && typeof window.performanceChart.destroy === 'function') {
                window.performanceChart.destroy();
            }
            
            // Ottieni sempre i report aggiornati (con await)
            const allReports = await getAllReports();
            let filteredReports = allReports;
            
            if (selectedMonth !== 'all') {
                filteredReports = allReports.filter(r => {
                    const date = new Date(r.date);
                    const reportMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return reportMonth === selectedMonth;
                });
            }
            
            if (filteredReports.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            const stores = [...new Set(filteredReports.map(r => r.store))];
            const storeData = stores.map(store => {
                const storeReports = filteredReports.filter(r => r.store === store);
                const avg = storeReports.reduce((sum, r) => sum + parseInt(r.score || 0), 0) / storeReports.length;
                return avg;
            });
            
            window.performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stores,
                    datasets: [{
                        label: 'Media Voti',
                        data: storeData,
                        backgroundColor: stores.map((_, i) => {
                            const score = storeData[i];
                            if (score >= 8) return 'rgba(0, 200, 150, 0.8)';
                            if (score >= 6) return 'rgba(255, 184, 0, 0.8)';
                            return 'rgba(255, 59, 59, 0.8)';
                        }),
                        borderColor: stores.map((_, i) => {
                            const score = storeData[i];
                            if (score >= 8) return 'rgba(0, 200, 150, 1)';
                            if (score >= 6) return 'rgba(255, 184, 0, 1)';
                            return 'rgba(255, 59, 59, 1)';
                        }),
                        borderWidth: 2,
                        borderRadius: 10,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: selectedMonth === 'all' ? 'Performance Generale Store' : 'Performance Store nel Periodo',
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Enter key support for login
        document.addEventListener('DOMContentLoaded', function() {
            const passwordField = document.getElementById('password');
            const usernameField = document.getElementById('username');
            
            if (passwordField) {
                passwordField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
            
            if (usernameField) {
                usernameField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('password').focus();
                    }
                });
            }
            
            checkAuth();
        });
        
        // Initialize particles on load
        window.addEventListener('load', function() {
            initializeParticles();
        });
    </script>
</body>
</html>
